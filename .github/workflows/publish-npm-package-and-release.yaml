name: Publish and Release

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ["package.json", ".github/workflows/**"]

jobs:
  test:
    runs-on: blacksmith-2vcpu-ubuntu-2204
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: npm ci
      - run: npm test

  build:
    runs-on: blacksmith-2vcpu-ubuntu-2204
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: npm ci
      - run: npm run build --declaration
      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  publish_npm:
    needs: [test, build]
    runs-on: blacksmith-2vcpu-ubuntu-2204
    continue-on-error: true
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      - run: |
          version=$(node -p "require('./package.json').version")
          package=$(node -p "require('./package.json').name")
          npm publish --access public
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  upload_release:
    needs: [test, build]

    runs-on: blacksmith-2vcpu-ubuntu-2204
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      - name: Get version
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      - uses: softprops/action-gh-release@v2.2.1
        with:
          files: dist/**
          tag_name: v${{ steps.version.outputs.version }}
          body: "Release v${{ steps.version.outputs.version }}"
          draft: true
          generate_release_notes: true

  publish_release:
    needs: [publish_npm, upload_release]
    runs-on: blacksmith-2vcpu-ubuntu-2204
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Get version
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
      - uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }} # this is needed bc otherwise the PR action silently fails, as Github checks if the release was made with the repo's token and does not trigger to prevent recursive workflow runs. Silently. Awesome.
